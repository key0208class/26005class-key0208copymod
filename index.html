<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›²æ•™å®¤æ–‡å­—å‰ªè²¼ç°¿V3 - å¯æ”¶åˆå´é‚Šæ¬„</title>
<style>
    /* --- å…¨åŸŸè¨­è¨ˆè®Šæ•¸ --- */
    :root {
        --primary-color: #007bff; /* ä¸»é¡Œè‰² */
        --primary-hover: #0056b3; /* ä¸»é¡Œæ‡¸åœè‰² */
        --secondary-color: #6c757d; /* æ¬¡è¦è‰² */
        --light-gray: #f8f9fa;      /* æ·ºç°è‰²èƒŒæ™¯ */
        --border-color: #dee2e6;    /* é‚Šæ¡†é¡è‰² */
        --card-bg: #ffffff;         /* å¡ç‰‡èƒŒæ™¯è‰² */
        --shadow: 0 4px 8px rgba(0,0,0,0.1); /* æ¨™æº–é™°å½± */
        --success-color: #28a745;   /* æˆåŠŸæç¤ºè‰² */
        --sidebar-width: 300px; /* å´é‚Šæ¬„å¯¬åº¦ */
    }

    /* --- åŸºæœ¬ä½ˆå±€ --- */
    body {
        font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        background-color: var(--light-gray);
        margin: 0;
        height: 100vh;
        overflow-x: hidden;
    }
    .container { 
        width: 100%; 
        height: 100%; 
        position: relative; 
    }
    
    /* --- ã€ä¿®æ”¹ã€‘å´é‚Šæ¬„é è¨­ç‚ºå›ºå®šå®šä½ï¼Œä¸¦ç§»å‡ºç•«é¢å¤– --- */
    .sidebar { 
        width: var(--sidebar-width); 
        min-width: 280px; 
        background-color: var(--card-bg); 
        border-right: 1px solid var(--border-color); 
        display: flex; 
        flex-direction: column; 
        padding: 15px; 
        box-shadow: var(--shadow); 
        z-index: 100;
        transition: transform 0.3s ease-in-out; /* æ»‘å‹•å‹•ç•«æ•ˆæœ */
        position: fixed; /* ã€ä¿®æ”¹ã€‘æ”¹ç‚ºå›ºå®šå®šä½ï¼Œä½¿å…¶è„«é›¢æ–‡æª”æµ */
        top: 0;
        left: 0;
        height: 100%;
        transform: translateX(-100%); /* ã€ä¿®æ”¹ã€‘é è¨­ç‹€æ…‹ä¸‹å‘å·¦ç§»å‡ºç•«é¢ */
    }

    /* --- ã€æ–°å¢ã€‘ç•¶å®¹å™¨æœ‰ .sidebar-open class æ™‚ï¼Œå°‡å´é‚Šæ¬„æ»‘å…¥ --- */
    .container.sidebar-open .sidebar {
        transform: translateX(0);
    }

    /* --- ã€ä¿®æ”¹ã€‘ä¸»å…§å®¹å€é è¨­å¡«æ»¿ï¼Œä¸¦å¢åŠ å·¦é‚Šå…§è·æ”¾ç½®æŒ‰éˆ• --- */
    .main-content { 
        flex-grow: 1; 
        padding: 20px; 
        overflow-y: auto; 
        position: relative;
        padding-left: 60px; /* ã€ä¿®æ”¹ã€‘å¢åŠ å·¦å…§è·ï¼Œé¿å…å…§å®¹è¢«æŒ‰éˆ•æ“‹ä½ */
        padding-top: 60px;  /* ã€ä¿®æ”¹ã€‘å¢åŠ ä¸Šå…§è·ï¼Œè®“æ¨™é¡Œèˆ‡æŒ‰éˆ•å°é½Š */
    }
    
    /* --- å´é‚Šæ¬„é–‹é—œæŒ‰éˆ• --- */
    .sidebar-toggle-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 98; /* ã€ä¿®æ”¹ã€‘Z-indexèª¿æ•´ï¼Œä¸éœ€è¦æ¯”å´é‚Šæ¬„é«˜ */
        display: block; /* ã€ä¿®æ”¹ã€‘æ°¸é é¡¯ç¤º */
        font-size: 20px;
        padding: 5px 10px;
        background-color: rgba(255,255,255,0.8);
        backdrop-filter: blur(5px);
        border: 1px solid var(--border-color);
    }

    /* --- è¢å¹•é®ç½© --- */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.4);
        z-index: 99;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease-in-out;
    }
    .container.sidebar-open .overlay {
        opacity: 1;
        pointer-events: auto;
    }

    /* --- ã€ä¿®æ”¹ã€‘ç§»é™¤åŸæœ‰çš„éŸ¿æ‡‰å¼ä½ˆå±€è®Šæ›´ï¼Œå› ç‚ºæ–°ä½ˆå±€å·²é©ç”¨æ‰€æœ‰å°ºå¯¸ --- */
    /* @media (max-width: 768px) { ... }  æ­¤å€å¡Šä¸­é—œæ–¼å´é‚Šæ¬„ transform çš„éƒ¨åˆ†å·²è¢«æ•´åˆç‚ºé è¨­æ¨£å¼ */


    /* --- å´é‚Šæ¬„å…ƒä»¶ (æ¨£å¼ä¸è®Š) --- */
    .sidebar-header { padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .quick-add-container { margin-bottom: 15px; }
    #quick-add-input { width: 100%; padding: 10px 12px; border-radius: 5px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; }
    #quick-add-input::placeholder { color: #999; }
    .search-box { width: 100%; padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; margin-bottom: 15px; }
    .category-controls { display: flex; justify-content: space-between; }
    .category-list { list-style: none; padding: 0; margin-top: 15px; overflow-y: auto; flex-grow: 1; }
    .category-item { padding: 12px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
    .category-item.special-category { font-weight: 500; color: #333; }
    .category-item:hover, .category-item.active { background-color: #e9ecef; }
    .category-item-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- ä¸»è¦å…§å®¹å€ (æ¨£å¼ä¸è®Š) --- */
    .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .content-header h2 { margin: 0; color: #333; }
    .snippet-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .snippet-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); display: flex; flex-direction: column; transition: box-shadow 0.3s; cursor: grab; }
    .snippet-card:active { cursor: grabbing; }
    .snippet-card.dragging { opacity: 0.5; background: #cce5ff; }
    .snippet-card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .snippet-header { font-weight: bold; padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .snippet-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .snippet-content { padding: 15px; white-space: pre-wrap; word-break: break-word; background-color: #fdfdfd; flex-grow: 1; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; color: #333; min-height: 80px; max-height: 200px; overflow-y: auto; }
    .snippet-footer { padding: 10px 15px; background-color: var(--light-gray); display: flex; justify-content: flex-end; border-top: 1px solid var(--border-color); }
    
    /* --- æŒ‰éˆ•èˆ‡äº’å‹•å…ƒä»¶ (æ¨£å¼ä¸è®Š) --- */
    .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s, opacity 0.2s; margin-left: 5px; white-space: nowrap; }
    .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: var(--primary-hover); } .btn-success { background-color: var(--success-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-danger { background-color: #dc3545; color: white; } .btn-sm { padding: 5px 10px; font-size: 12px; } .btn-icon { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; line-height: 1; } .btn-icon:hover { background-color: rgba(0,0,0,0.1); }
    .category-actions .btn-icon { visibility: hidden; opacity: 0; transition: opacity 0.2s; } .category-item:not(.special-category):hover .category-actions .btn-icon { visibility: visible; opacity: 1; }
    #no-snippets-message { color: var(--secondary-color); }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.75); color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s, transform 0.3s; }

    /* --- å½ˆå‡ºå¼è¦–çª— (Modal) (æ¨£å¼ä¸è®Š) --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-overlay.show { opacity: 1; pointer-events: auto; } .modal { background-color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s ease; } .modal-overlay.show .modal { transform: scale(1); }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-size: 1.2em; font-weight: 500; } .modal-body { padding: 20px; } .modal-body input, .modal-body textarea, .modal-body select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
    .modal-body textarea { min-height: 150px; resize: vertical; margin-top: 15px; } .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); text-align: right; }
    .emoji-picker { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-bottom: 15px; } .emoji-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s; } .emoji-btn:hover { background-color: #f0f0f0; }
</style>
</head>
<body>

<div class="container" id="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="quick-add-container">
                <input type="text" id="quick-add-input" placeholder="å¿«é€Ÿæ–°å¢ç¯„æœ¬å¾ŒæŒ‰ Enter...">
            </div>
            <input type="text" id="search-box" class="search-box" placeholder="ğŸ” æœå°‹æ‰€æœ‰ç¯„æœ¬...">
            <div class="category-controls">
                <button id="add-category-btn" class="btn btn-primary btn-sm">æ–°å¢åˆ†é¡</button>
                <div>
                    <button id="import-btn" class="btn btn-secondary btn-sm" title="å¾æœ¬æ©Ÿæª”æ¡ˆåŒ¯å…¥ä¸¦è¦†è“‹é›²ç«¯è³‡æ–™">åŒ¯å…¥</button>
                    <button id="export-btn" class="btn btn-secondary btn-sm" title="å°‡é›²ç«¯è³‡æ–™åŒ¯å‡ºè‡³æœ¬æ©Ÿ">åŒ¯å‡º</button>
                </div>
            </div>
        </div>
        <ul id="category-list" class="category-list"></ul>
    </aside>

    <main class="main-content">
        <button id="sidebar-toggle-btn" class="btn sidebar-toggle-btn">â˜°</button>

        <div class="content-header">
            <h2 id="current-category-title">æ‰€æœ‰é …ç›®</h2>
            <button id="add-snippet-btn" class="btn btn-primary">æ–°å¢ç¯„æœ¬</button>
        </div>
        <div id="snippet-list" class="snippet-list"></div>
        <p id="no-snippets-message" style="display: none;">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è³‡æ–™...</p>
    </main>
    
    <div class="overlay" id="overlay"></div>
</div>

<div id="category-modal-overlay" class="modal-overlay"> <div class="modal"> <div class="modal-header" id="category-modal-title"></div> <div class="modal-body"> <div id="emoji-picker" class="emoji-picker"></div> <input type="text" id="category-modal-input" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨±"> </div> <div class="modal-footer"> <button id="category-modal-cancel" class="btn btn-secondary">å–æ¶ˆ</button> <button id="category-modal-confirm" class="btn btn-primary">ç¢ºå®š</button> </div> </div> </div>
<div id="snippet-modal-overlay" class="modal-overlay"> <div class="modal"> <div class="modal-header" id="snippet-modal-title"></div> <div class="modal-body"> <input type="text" id="snippet-modal-title-input" placeholder="è«‹è¼¸å…¥ç¯„æœ¬æ¨™é¡Œ"> <textarea id="snippet-modal-content-input" placeholder="è«‹è¼¸å…¥ç¯„æœ¬å…§å®¹"></textarea> </div> <div class="modal-footer"> <button id="snippet-modal-cancel" class="btn btn-secondary">å–æ¶ˆ</button> <button id="snippet-modal-confirm" class="btn btn-primary">ç¢ºå®š</button> </div> </div> </div>
<div id="move-snippet-modal-overlay" class="modal-overlay"> <div class="modal"> <div class="modal-header">ç§»å‹•ç¯„æœ¬è‡³</div> <div class="modal-body"> <select id="move-snippet-category-select"></select> </div> <div class="modal-footer"> <button id="move-snippet-modal-cancel" class="btn btn-secondary">å–æ¶ˆ</button> <button id="move-snippet-modal-confirm" class="btn btn-primary">ç¢ºå®š</button> </div> </div> </div>
<input type="file" id="import-file-input" accept=".json" style="display: none;">

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
// JavaScript é‚è¼¯å®Œå…¨ä¸éœ€è¦ä¿®æ”¹ï¼Œå› ç‚ºåŸæœ‰çš„ setupSidebarToggle() å‡½å¼è¨­è¨ˆå¾—éå¸¸å¥½ï¼Œ
// å®ƒé€éåˆ‡æ› .sidebar-open class ä¾†æ§åˆ¶ç‹€æ…‹ï¼Œæˆ‘å€‘çš„ CSS ä¿®æ”¹æ­£æ˜¯åŸºæ–¼é€™å€‹ class ä¾†å¯¦ç¾å‹•ç•«çš„ã€‚
document.addEventListener('DOMContentLoaded', () => {

    // --- Firebase è¨­å®š ---
    // â–¼â–¼â–¼â–¼â–¼ è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®šç¢¼ â–¼â–¼â–¼â–¼â–¼
    const firebaseConfig = {
      apiKey: "AIzaSyAlyiXLGareglGA3NE3X-Oupt6OJpZpn1U",
      authDomain: "myonlineclipboard-ce3eb.firebaseapp.com",
      projectId: "myonlineclipboard-ce3eb",
      storageBucket: "myonlineclipboard-ce3eb.firebasestorage.app",
      messagingSenderId: "233956851057",
      appId: "1:233956851057:web:0060206d87bd77ea888ad0"
    };
    // â–²â–²â–²â–²â–² è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®šç¢¼ â–²â–²â–²â–²â–²

    // --- æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ---
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šç¢¼: ", e);
        alert("Firebase åˆå§‹åŒ–å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„è¨­å®šç¢¼æ˜¯å¦å·²æ­£ç¢ºè²¼ä¸Šã€‚");
        return;
    }
    
    const db = firebase.firestore();
    const docRef = db.collection("clipboardData").doc("main");

    // --- DOM å…ƒç´ å®šç¾© ---
    const appContainer = document.getElementById('app-container');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
    const overlay = document.getElementById('overlay');
    const categoryList = document.getElementById('category-list');
    const snippetList = document.getElementById('snippet-list');
    const currentCategoryTitle = document.getElementById('current-category-title');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addSnippetBtn = document.getElementById('add-snippet-btn');
    const searchBox = document.getElementById('search-box');
    const noSnippetsMessage = document.getElementById('no-snippets-message');
    const importBtn = document.getElementById('import-btn');
    const exportBtn = document.getElementById('export-btn');
    const quickAddInput = document.getElementById('quick-add-input');
    const importFileInput = document.getElementById('import-file-input');
    const categoryModalOverlay = document.getElementById('category-modal-overlay'); const categoryModalInput = document.getElementById('category-modal-input'); const categoryModalConfirm = document.getElementById('category-modal-confirm'); const categoryModalCancel = document.getElementById('category-modal-cancel'); const categoryModalTitle = document.getElementById('category-modal-title'); const emojiPicker = document.getElementById('emoji-picker'); const snippetModalOverlay = document.getElementById('snippet-modal-overlay'); const snippetModalTitleInput = document.getElementById('snippet-modal-title-input'); const snippetModalContentInput = document.getElementById('snippet-modal-content-input'); const snippetModalConfirm = document.getElementById('snippet-modal-confirm'); const snippetModalCancel = document.getElementById('snippet-modal-cancel'); const snippetModalTitle = document.getElementById('snippet-modal-title'); const moveSnippetModalOverlay = document.getElementById('move-snippet-modal-overlay'); const moveSnippetCategorySelect = document.getElementById('move-snippet-category-select'); const moveSnippetModalConfirm = document.getElementById('move-snippet-modal-confirm'); const moveSnippetModalCancel = document.getElementById('move-snippet-modal-cancel');
    
    // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ (è³‡æ–™æ¨¡å‹) ---
    let data = [];
    let activeCategoryId = 'all';
    const UNCATEGORIZED_ID = 'cat-uncategorized';

    // --- Firebase æ ¸å¿ƒåŠŸèƒ½ ---
    async function saveData(newData) { 
        try {
            await docRef.set({ categories: newData });
            showToast('ğŸ’¾ è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯');
        } catch (error) {
            console.error("å„²å­˜è³‡æ–™è‡³ Firebase æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error);
            alert("å„²å­˜å¤±æ•—ï¼ç„¡æ³•é€£æ¥è‡³é›²ç«¯è³‡æ–™åº«ã€‚");
        }
    }
    function setupRealtimeListener() { 
        docRef.onSnapshot(doc => {
            if (doc.exists) {
                const cloudData = doc.data().categories || [];
                if (!cloudData.find(c => c.id === UNCATEGORIZED_ID)) {
                    cloudData.push({ id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] });
                }
                data = cloudData;
                noSnippetsMessage.textContent = 'é€™å€‹åˆ†é¡ä¸‹é‚„æ²’æœ‰ä»»ä½•ç¯„æœ¬ã€‚';
            } else {
                console.log("é›²ç«¯ç„¡è³‡æ–™ï¼Œæ­£åœ¨å»ºç«‹åˆå§‹è³‡æ–™...");
                const defaultData = [
                    { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] },
                    { id: 'cat-1', name: 'âœï¸ å­¸æ ¡ç”¨', snippets: [{ id: 'snip-1-1', title: 'å›å®¶ä½œæ¥­æ ¼å¼', content: 'åœ‹èªï¼š\næ•¸å­¸ï¼š\nè‹±æ–‡ï¼š\nå…¶ä»–ï¼š' }] },
                ];
                data = defaultData;
                saveData(data);
            }
            render();
        }, error => {
            console.error("Firebase ç›£è½å™¨éŒ¯èª¤: ", error);
            noSnippetsMessage.textContent = 'ç„¡æ³•é€£æ¥é›²ç«¯è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®šã€‚';
            noSnippetsMessage.style.display = 'block';
        });
    }

    // --- æ‹–æ›³æ’åºé‚è¼¯ ---
    function setupDragAndDrop() { 
        let draggedItemId = null;
        snippetList.addEventListener('dragstart', e => {
            const card = e.target.closest('.snippet-card');
            if (card) {
                draggedItemId = card.dataset.id;
                setTimeout(() => card.classList.add('dragging'), 0);
            }
        });
        snippetList.addEventListener('dragend', e => {
            const card = e.target.closest('.snippet-card');
            if (card) card.classList.remove('dragging');
        });
        snippetList.addEventListener('dragover', e => e.preventDefault());
        snippetList.addEventListener('drop', e => {
            e.preventDefault();
            const targetCard = e.target.closest('.snippet-card');
            if (!targetCard || targetCard.dataset.id === draggedItemId) return;
            const category = data.find(c => c.id === activeCategoryId);
            if (!category) return;
            const snippetArray = category.snippets;
            const startIndex = snippetArray.findIndex(s => s.id === draggedItemId);
            const endIndex = snippetArray.findIndex(s => s.id === targetCard.dataset.id);
            if (startIndex === -1 || endIndex === -1) return;
            const [removed] = snippetArray.splice(startIndex, 1);
            snippetArray.splice(endIndex, 0, removed);
            saveData(data);
        });
    }

    // --- æ¸²æŸ“å‡½å¼ ---
    function render() { 
        renderCategories();
        renderSnippets();
    }
    function renderCategories() { 
        categoryList.innerHTML = '';
        const specialCategories = [
            { id: 'all', name: 'ğŸ“‘ æ‰€æœ‰ç¯„æœ¬' },
            { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬' }
        ];
        specialCategories.forEach(cat => {
            const catData = data.find(c => c.id === cat.id);
            const count = cat.id === 'all' 
                ? data.reduce((sum, c) => sum + (c.snippets ? c.snippets.length : 0), 0) 
                : catData ? (catData.snippets ? catData.snippets.length : 0) : 0;
            const li = document.createElement('li');
            li.className = `category-item special-category ${cat.id === activeCategoryId ? 'active' : ''}`;
            li.dataset.id = cat.id;
            li.innerHTML = `<span class="category-item-name">${escapeHtml(cat.name)} (${count})</span>`;
            categoryList.appendChild(li);
        });
        categoryList.appendChild(document.createElement('hr'));
        data.filter(c => c.id !== UNCATEGORIZED_ID).forEach(category => {
            const li = document.createElement('li');
            li.className = `category-item ${category.id === activeCategoryId ? 'active' : ''}`;
            li.dataset.id = category.id;
            li.innerHTML = `<span class="category-item-name">${escapeHtml(category.name)} (${category.snippets ? category.snippets.length : 0})</span>
                            <span class="category-actions">
                                <button class="btn-icon edit-cat-btn" title="ç·¨è¼¯åˆ†é¡">âœï¸</button>
                                <button class="btn-icon delete-cat-btn" title="åˆªé™¤åˆ†é¡">ğŸ—‘ï¸</button>
                            </span>`;
            categoryList.appendChild(li);
        });
    }
    function renderSnippets() {
        snippetList.innerHTML = '';
        const searchQuery = searchBox.value.toLowerCase();
        let snippetsToRender = [];
        let categoryName = '';
        let allowDrag = false;
        addSnippetBtn.style.display = 'block';
        if (searchQuery) {
            snippetsToRender = data.flatMap(c => c.snippets || []).filter(s => s.title.toLowerCase().includes(searchQuery) || s.content.toLowerCase().includes(searchQuery));
            categoryName = `æœå°‹çµæœ: "${searchQuery}"`;
            addSnippetBtn.style.display = 'none';
        } else if (activeCategoryId === 'all') {
            snippetsToRender = data.flatMap(c => c.snippets || []);
            categoryName = 'æ‰€æœ‰ç¯„æœ¬';
            addSnippetBtn.style.display = 'none';
        } else {
            const category = data.find(c => c.id === activeCategoryId);
            if (category) {
                snippetsToRender = category.snippets || [];
                categoryName = category.name;
                allowDrag = true;
            }
        }
        currentCategoryTitle.textContent = escapeHtml(categoryName);
        if (snippetsToRender.length > 0) {
            noSnippetsMessage.style.display = 'none';
            snippetsToRender.forEach(snippet => {
                const card = document.createElement('div');
                card.className = 'snippet-card';
                card.dataset.id = snippet.id;
                card.draggable = allowDrag;
                card.innerHTML = `
                    <div class="snippet-header">
                        <span class="snippet-title">${escapeHtml(snippet.title)}</span>
                        <div class="snippet-actions">
                            <button class="btn btn-sm btn-secondary move-snippet-btn">ç§»å‹•</button>
                            <button class="btn btn-sm btn-secondary edit-snippet-btn">ç·¨è¼¯</button>
                            <button class="btn btn-sm btn-danger delete-snippet-btn">åˆªé™¤</button>
                        </div>
                    </div>
                    <div class="snippet-content">${escapeHtml(snippet.content)}</div>
                    <div class="snippet-footer">
                        <button class="btn btn-success copy-snippet-btn">è¤‡è£½å…§å®¹</button>
                    </div>`;
                snippetList.appendChild(card);
            });
        } else {
            noSnippetsMessage.style.display = 'block';
        }
    }
    
    // --- äº‹ä»¶ç›£è½å™¨ ---
    function setupSidebarToggle() {
        sidebarToggleBtn.addEventListener('click', () => {
            appContainer.classList.toggle('sidebar-open');
        });
        overlay.addEventListener('click', () => {
            appContainer.classList.remove('sidebar-open');
        });
    }
    
    quickAddInput.addEventListener('keydown', e => { 
        if (e.key === 'Enter' && quickAddInput.value.trim() !== '') {
            e.preventDefault();
            const content = quickAddInput.value.trim();
            let uncategorized = data.find(c => c.id === UNCATEGORIZED_ID);
            if (!uncategorized) {
                uncategorized = { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] };
                data.push(uncategorized);
            }
            const newSnippet = {
                id: `snip-${Date.now()}`,
                title: content.substring(0, 15) + (content.length > 15 ? '...' : ''),
                content: content
            };
            uncategorized.snippets.unshift(newSnippet);
            quickAddInput.value = '';
            showToast('âœ… å¿«é€Ÿæ–°å¢è‡³ã€Œæœªåˆ†é¡ã€');
            saveData(data);
        }
    });

    categoryList.addEventListener('click', e => {
        const categoryItem = e.target.closest('.category-item');
        if (!categoryItem) return;
        const categoryId = categoryItem.dataset.id;
        if (e.target.closest('.edit-cat-btn')) {
            modalControls.openCategoryModal(categoryId);
        } else if (e.target.closest('.delete-cat-btn')) {
            deleteCategory(categoryId);
        } else {
            activeCategoryId = categoryId;
            searchBox.value = '';
            render();
            // åœ¨ä»»ä½•è£ç½®ä¸Šé»æ“Šåˆ†é¡å¾Œéƒ½é—œé–‰å´é‚Šæ¬„
            appContainer.classList.remove('sidebar-open');
        }
    });

    snippetList.addEventListener('click', e => { 
        const card = e.target.closest('.snippet-card');
        if (!card) return;
        const snippetId = card.dataset.id;
        if (e.target.matches('.copy-snippet-btn')) {
            const content = card.querySelector('.snippet-content').innerText;
            navigator.clipboard.writeText(content).then(() => showToast('âœ… å·²è¤‡è£½ï¼'), () => showToast('âŒ è¤‡è£½å¤±æ•—'));
        } else if (e.target.matches('.edit-snippet-btn')) {
            modalControls.openSnippetModal(snippetId);
        } else if (e.target.matches('.delete-snippet-btn')) {
            deleteSnippet(snippetId);
        } else if (e.target.matches('.move-snippet-btn')) {
            modalControls.openMoveSnippetModal(snippetId);
        }
    });

    searchBox.addEventListener('input', renderSnippets);

    // --- è³‡æ–™æ“ä½œå‡½å¼ ---
    function findSnippetLocation(snippetId) { 
        for (const category of data) {
            if (category.snippets) {
                const index = category.snippets.findIndex(s => s.id === snippetId);
                if (index !== -1) return [category.id, index];
            }
        }
        return [null, -1];
    }
    function deleteCategory(categoryId) {
        const category = data.find(c => c.id === categoryId);
        if (!category) return;
        if (confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${category.name}ã€å—ï¼Ÿ\nåˆ†é¡ä¸‹çš„æ‰€æœ‰ç¯„æœ¬å°‡æœƒè¢«ç§»è‡³ã€Œæœªåˆ†é¡ç¯„æœ¬ã€ã€‚`)) {
            let uncategorized = data.find(c => c.id === UNCATEGORIZED_ID);
            if (!uncategorized) {
                uncategorized = { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] };
                data.push(uncategorized);
            }
            uncategorized.snippets.unshift(...(category.snippets || []));
            const newData = data.filter(c => c.id !== categoryId);
            if (activeCategoryId === categoryId) activeCategoryId = UNCATEGORIZED_ID;
            saveData(newData);
        }
    }
    function deleteSnippet(snippetId) { 
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¯„æœ¬å—ï¼Ÿ')) {
            const [categoryId, snippetIndex] = findSnippetLocation(snippetId);
            if (categoryId !== null) {
                const category = data.find(c => c.id === categoryId);
                category.snippets.splice(snippetIndex, 1);
                saveData(data);
            }
        }
    }

    // --- Modal æ§åˆ¶æ¨¡çµ„ ---
    const modalControls = (() => {
        let currentEditingCategoryId = null, currentEditingSnippetId = null, currentMovingSnippetId = null;
        const commonEmojis = ['âœï¸', 'ğŸ’¼', 'ğŸ“±', 'ğŸ ', 'â¤ï¸', 'ğŸ’¡', 'âœˆï¸', 'ğŸš—', 'ğŸ›’', 'ğŸ½ï¸', 'ğŸ‰', 'ğŸ’¬', 'ğŸ“Œ', 'ğŸ“', 'âœ…', 'âŒ', 'ğŸ’°', 'ğŸ”‘', 'ğŸ”—', 'ğŸ“', 'ğŸ“…', 'â°', 'â­ï¸', 'â„¹ï¸', 'â“', 'ğŸ› ï¸', 'âš™ï¸', 'ğŸ–¥ï¸', 'ğŸ“š', 'ğŸ“¦'];
        emojiPicker.innerHTML = commonEmojis.map(emoji => `<button class="emoji-btn">${emoji}</button>`).join('');
        function openCategoryModal(categoryId = null) {
            currentEditingCategoryId = categoryId;
            if (categoryId) {
                const category = data.find(c => c.id === categoryId);
                categoryModalTitle.textContent = 'ç·¨è¼¯åˆ†é¡';
                categoryModalInput.value = category.name;
            } else {
                categoryModalTitle.textContent = 'æ–°å¢åˆ†é¡';
                categoryModalInput.value = '';
            }
            categoryModalOverlay.classList.add('show');
            categoryModalInput.focus();
        }
        function closeCategoryModal() { categoryModalOverlay.classList.remove('show'); }
        function openSnippetModal(snippetId = null) {
            currentEditingSnippetId = snippetId;
            if (snippetId) {
                const [categoryId, snippetIndex] = findSnippetLocation(snippetId);
                const snippet = data.find(c => c.id === categoryId).snippets[snippetIndex];
                snippetModalTitle.textContent = 'ç·¨è¼¯ç¯„æœ¬';
                snippetModalTitleInput.value = snippet.title;
                snippetModalContentInput.value = snippet.content;
            } else {
                if (!activeCategoryId || activeCategoryId === 'all') {
                    alert('è«‹å…ˆå¾å·¦å´é¸æ“‡ä¸€å€‹è¦æ–°å¢ç¯„æœ¬çš„åˆ†é¡ï¼'); return;
                }
                snippetModalTitle.textContent = 'æ–°å¢ç¯„æœ¬';
                snippetModalTitleInput.value = '';
                snippetModalContentInput.value = '';
            }
            snippetModalOverlay.classList.add('show');
            snippetModalTitleInput.focus();
        }
        function closeSnippetModal() { snippetModalOverlay.classList.remove('show'); }
        function openMoveSnippetModal(snippetId) {
            currentMovingSnippetId = snippetId;
            const [currentCatId] = findSnippetLocation(snippetId);
            moveSnippetCategorySelect.innerHTML = '';
            data.filter(cat => cat.id !== currentCatId).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                moveSnippetCategorySelect.appendChild(option);
            });
            moveSnippetModalOverlay.classList.add('show');
        }
        function closeMoveSnippetModal() { moveSnippetModalOverlay.classList.remove('show'); }
        addCategoryBtn.addEventListener('click', () => openCategoryModal());
        categoryModalCancel.addEventListener('click', closeCategoryModal);
        emojiPicker.addEventListener('click', e => {
            if (e.target.classList.contains('emoji-btn')) {
                categoryModalInput.value += e.target.textContent;
                categoryModalInput.focus();
            }
        });
        categoryModalConfirm.addEventListener('click', () => {
            const name = categoryModalInput.value.trim();
            if (!name) return;
            if (currentEditingCategoryId) {
                const category = data.find(c => c.id === currentEditingCategoryId);
                if (category) category.name = name;
            } else {
                const newCategory = { id: `cat-${Date.now()}`, name, snippets: [] };
                data.push(newCategory);
                activeCategoryId = newCategory.id;
            }
            saveData(data);
            closeCategoryModal();
        });
        addSnippetBtn.addEventListener('click', () => openSnippetModal());
        snippetModalCancel.addEventListener('click', closeSnippetModal);
        snippetModalConfirm.addEventListener('click', () => {
            const title = snippetModalTitleInput.value.trim();
            const content = snippetModalContentInput.value;
            if (!title) return;
            if (currentEditingSnippetId) {
                const [categoryId, snippetIndex] = findSnippetLocation(currentEditingSnippetId);
                const snippet = data.find(c => c.id === categoryId).snippets[snippetIndex];
                snippet.title = title;
                snippet.content = content;
                showToast('ğŸ’¾ ç¯„æœ¬å·²æ›´æ–°');
            } else {
                const newSnippet = { id: `snip-${Date.now()}`, title, content };
                const category = data.find(c => c.id === activeCategoryId);
                if (category) category.snippets.unshift(newSnippet);
                showToast('âœ… ç¯„æœ¬å·²æ–°å¢');
            }
            saveData(data);
            closeSnippetModal();
        });
        moveSnippetModalCancel.addEventListener('click', closeMoveSnippetModal);
        moveSnippetModalConfirm.addEventListener('click', () => {
            const targetCatId = moveSnippetCategorySelect.value;
            if (!targetCatId || !currentMovingSnippetId) return;
            const [sourceCatId, sourceIndex] = findSnippetLocation(currentMovingSnippetId);
            if(sourceCatId === null) return;
            const sourceCategory = data.find(c => c.id === sourceCatId);
            const targetCategory = data.find(c => c.id === targetCatId);
            const [snippetToMove] = sourceCategory.snippets.splice(sourceIndex, 1);
            targetCategory.snippets.unshift(snippetToMove);
            showToast('âœ… ç¯„æœ¬å·²ç§»å‹•');
            saveData(data);
            closeMoveSnippetModal();
        });
        [categoryModalOverlay, snippetModalOverlay, moveSnippetModalOverlay].forEach(overlay => {
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); });
        });
        return { openCategoryModal, openSnippetModal, openMoveSnippetModal };
    })();
    
    // --- åŒ¯å…¥/åŒ¯å‡ºåŠŸèƒ½ ---
    exportBtn.addEventListener('click', () => {
        if(data.length === 0){ showToast("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º"); return; }
        const dataStr = JSON.stringify(data.filter(c => c.id !== 'all'), null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `clipboard-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('âœ… è³‡æ–™å·²åŒ¯å‡º');
    });
    importBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedData = JSON.parse(event.target.result);
                if (Array.isArray(importedData) && importedData.every(c => c.id && c.name && Array.isArray(c.snippets))) {
                    if (confirm('ç¢ºå®šè¦åŒ¯å…¥æ–°çš„è³‡æ–™å—ï¼Ÿé€™å°‡æœƒè¦†è“‹æ‚¨ç›®å‰çš„é›²ç«¯è³‡æ–™ï¼')) {
                        activeCategoryId = 'all';
                        saveData(importedData);
                        showToast('âœ… è³‡æ–™å·²ä¸Šå‚³è‡³é›²ç«¯ï¼');
                    }
                } else { throw new Error('Invalid file format'); }
            } catch (error) {
                alert('åŒ¯å…¥å¤±æ•—ï¼è«‹ç¢ºèªæª”æ¡ˆæ˜¯æ­£ç¢ºçš„ JSON æ ¼å¼ã€‚');
                console.error('Import failed:', error);
            } finally {
                importFileInput.value = '';
            }
        };
        reader.readAsText(file);
    });

    // --- å·¥å…·å‡½å¼ ---
    function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    function showToast(message) { const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateX(-50%) translateY(-10px)'; }, 10); setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(-50%) translateY(0)'; setTimeout(() => toast.remove(), 300); }, 2000); }

    // --- å•Ÿå‹•æ‡‰ç”¨ ---
    if (firebaseConfig.apiKey.startsWith("AIzaSyA") && firebaseConfig.apiKey.length > 35) {
      // ç°¡æ˜“æª¢æŸ¥ apiKey æ˜¯å¦æœ‰å¡«å¯«
    } else {
        alert("éŒ¯èª¤ï¼šè«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®šç¢¼ (firebaseConfig)ï¼");
        noSnippetsMessage.textContent = 'Firebase å°šæœªè¨­å®šã€‚è«‹ä¾ç…§èªªæ˜æ–‡ä»¶è¨­å®šå¾Œé‡æ–°æ•´ç†é é¢ã€‚';
        noSnippetsMessage.style.display = 'block';
        return;
    }
    setupRealtimeListener();
    setupDragAndDrop();
    setupSidebarToggle();
});
</script>

</body>
</html>