<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é›²æ•™å®¤æ–‡å­—å‰ªè²¼ç°¿V3</title>
<style>
    /* --- å…¨åŸŸè¨­è¨ˆè®Šæ•¸ --- */
    :root {
        --primary-color: #007bff;
        --primary-hover: #0056b3;
        --secondary-color: #6c757d;
        --light-gray: #f8f9fa;
        --border-color: #dee2e6;
        --card-bg: #ffffff;
        --shadow: 0 4px 8px rgba(0,0,0,0.1);
        --success-color: #28a745;
        --sidebar-width: 300px;
    }

    /* --- åŸºæœ¬ä½ˆå±€ --- */
    body {
        font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        background-color: var(--light-gray);
        margin: 0;
        height: 100vh;
        overflow: hidden;
    }
    .container { 
        display: flex;
        width: 100%; 
        height: 100%; 
    }
    
    /* --- å´é‚Šæ¬„ä½ˆå±€èˆ‡å‹•ç•« --- */
    .sidebar { 
        position: relative; 
        width: var(--sidebar-width); 
        min-width: 280px; 
        background-color: var(--card-bg); 
        border-right: 1px solid var(--border-color); 
        display: flex; 
        flex-direction: column; 
        padding: 15px; 
        box-shadow: var(--shadow); 
        z-index: 100;
        flex-shrink: 0;
        transition: margin-left 0.3s ease-in-out;
        margin-left: calc(var(--sidebar-width) * -1);
    }
    .container.sidebar-open .sidebar {
        margin-left: 0;
    }

    /* --- ä¸»å…§å®¹å€ä½ˆå±€ --- */
    .main-content { 
        flex-grow: 1; 
        padding: 20px; 
        overflow-y: auto;
        height: 100vh;
        box-sizing: border-box;
    }
    
    /* --- å´é‚Šæ¬„é–‹é—œæŒ‰éˆ• --- */
    .sidebar-toggle-btn {
        position: absolute;
        top: 50%;
        left: 100%;
        transform: translate(-50%, -50%); 
        z-index: 101;
        width: 30px;
        height: 70px;
        padding: 0;
        border: 1px solid var(--border-color);
        background-color: rgba(255,255,255,0.9);
        backdrop-filter: blur(5px);
        border-radius: 8px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px; 
    }
    .sidebar-toggle-btn:hover { 
        background-color: white;
        box-shadow: 3px 0 8px rgba(0,0,0,0.15);
    }
    .sidebar-toggle-btn .icon-open, .sidebar-toggle-btn .icon-close { transition: opacity 0.2s; }
    .sidebar-toggle-btn .icon-close { display: none; }
    .container.sidebar-open .sidebar-toggle-btn .icon-open { display: none; }
    .container.sidebar-open .sidebar-toggle-btn .icon-close { display: inline; }

    /* --- ã€CSS æ–°å¢ã€‘ä½¿ç”¨è€…é©—è­‰å€å¡Š --- */
    #auth-container {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
        margin: -15px -15px 15px -15px; /* ä¸Šä¸‹å·¦å³è²¼é½Š sidebar padding */
        background-color: #f8f9fa;
        text-align: center;
    }
    #user-profile {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }
    #user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        overflow: hidden;
    }
    #user-pic {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    #user-name {
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #login-btn, #logout-btn {
        width: 100%;
    }
    .hidden {
        display: none !important;
    }


    /* --- å…¶é¤˜æ¨£å¼ --- */
    .sidebar-header { padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .quick-add-container { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; }
    #quick-add-input { flex-grow: 1; width: auto; padding: 10px 12px; border-radius: 5px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; }
    #quick-add-btn { flex-shrink: 0; padding: 8px 12px; line-height: 1.2; }
    .search-box { width: 100%; padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; margin-bottom: 15px; }
    .category-controls { display: flex; justify-content: space-between; }
    .category-list { list-style: none; padding: 0; margin-top: 15px; overflow-y: auto; flex-grow: 1; }
    .category-item { padding: 12px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
    .category-item.special-category { font-weight: 500; color: #333; }
    .category-item:hover, .category-item.active { background-color: #e9ecef; }
    .category-item-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .content-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
    .content-header h2 { margin: 0; color: #333; }
    .header-controls { display: flex; align-items: center; gap: 20px;}
    .snippet-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .snippet-card { border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); display: flex; flex-direction: column; transition: box-shadow 0.3s, background-color 0.3s; cursor: grab; }
    .snippet-card:active { cursor: grabbing; }
    .snippet-card.dragging { opacity: 0.5; background: #cce5ff; }
    .snippet-card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .snippet-header { font-weight: bold; padding: 12px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .snippet-title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .snippet-content { padding: 15px; white-space: pre-wrap; word-break: break-word; background-color: rgba(255,255,255,0.6); flex-grow: 1; font-family: 'Consolas', 'Monaco', monospace; color: #333; min-height: 80px; max-height: 200px; overflow-y: auto; transition: font-size 0.2s; margin: 0 1px; }
    .snippet-footer { padding: 10px 15px; background-color: transparent; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; border-top: 1px solid var(--border-color); gap: 10px; }
    .font-controls { display: flex; align-items: center; gap: 4px; background-color: var(--light-gray); padding: 2px 4px; border-radius: 5px; }
    .font-controls .btn-icon { background-color: #fff; border: 1px solid var(--border-color); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; line-height: 1; }
    .font-controls .current-font-size { font-size: 12px; font-weight: normal; color: var(--secondary-color); min-width: 30px; text-align: center; }
    .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s, opacity 0.2s; white-space: nowrap; }
    .btn:not(:last-child) { margin-right: 5px; }
    .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: var(--primary-hover); } .btn-success { background-color: var(--success-color); color: white; } .btn-secondary { background-color: var(--secondary-color); color: white; } .btn-danger { background-color: #dc3545; color: white; } .btn-sm { padding: 5px 10px; font-size: 12px; } .btn-icon { background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; line-height: 1; } .btn-icon:hover { background-color: rgba(0,0,0,0.1); }
    .category-actions .btn-icon { visibility: hidden; opacity: 0; transition: opacity 0.2s; } .category-item:not(.special-category):hover .category-actions .btn-icon { visibility: visible; opacity: 1; }
    .color-palette { display: flex; align-items: center; gap: 6px; width: 100%; padding-top: 8px; order: 10; }
    .color-swatch { width: 22px; height: 22px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .color-swatch:hover { transform: scale(1.15); }
    .color-swatch.active { border-color: var(--primary-color); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary-color); }
    #no-snippets-message { color: var(--secondary-color); text-align: center; margin-top: 40px;}
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.75); color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s, transform 0.3s; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-overlay.show { opacity: 1; pointer-events: auto; } .modal { background-color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; transform: scale(0.9); transition: transform 0.3s ease; } .modal-overlay.show .modal { transform: scale(1); }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); font-size: 1.2em; font-weight: 500; } .modal-body { padding: 20px; } .modal-body input, .modal-body textarea, .modal-body select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
    .modal-body textarea { min-height: 150px; resize: vertical; margin-top: 15px; } .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border-color); text-align: right; }
    .emoji-picker { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 5px; margin-bottom: 15px; } .emoji-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; padding: 5px; border-radius: 4px; transition: background-color 0.2s; } .emoji-btn:hover { background-color: #f0f0f0; }
</style>
</head>
<body>

<div class="container" id="app-container">
    <aside class="sidebar">
        <div id="auth-container">
            <div id="user-profile" class="hidden">
                <div id="user-info">
                    <img id="user-pic" src="" alt="User photo">
                    <span id="user-name"></span>
                </div>
                <button id="logout-btn" class="btn btn-secondary btn-sm">ç™»å‡º</button>
            </div>
            <button id="login-btn" class="btn btn-primary">ä½¿ç”¨ Google ç™»å…¥ä»¥ç·¨è¼¯</button>
        </div>

        <div class="sidebar-header">
            <div class="quick-add-container">
                <input type="text" id="quick-add-input" placeholder="å¿«é€Ÿæ–°å¢ç¯„æœ¬...">
                <button id="quick-add-btn" class="btn btn-success btn-sm" title="æ–°å¢">æ–°å¢</button>
            </div>
            <input type="text" id="search-box" class="search-box" placeholder="ğŸ” æœå°‹æ‰€æœ‰ç¯„æœ¬...">
            <div class="category-controls">
                <button id="add-category-btn" class="btn btn-primary btn-sm">æ–°å¢åˆ†é¡</button>
                <div>
                    <button id="import-btn" class="btn btn-secondary btn-sm" title="å¾æœ¬æ©Ÿæª”æ¡ˆåŒ¯å…¥ä¸¦è¦†è“‹é›²ç«¯è³‡æ–™">åŒ¯å…¥</button>
                    <button id="export-btn" class="btn btn-secondary btn-sm" title="å°‡é›²ç«¯è³‡æ–™åŒ¯å‡ºè‡³æœ¬æ©Ÿ">åŒ¯å‡º</button>
                </div>
            </div>
        </div>
        <ul id="category-list" class="category-list"></ul>
        
        <button id="sidebar-toggle-btn" class="sidebar-toggle-btn" title="é–‹é—œå´é‚Šæ¬„">
            <span class="icon-open">â–¶</span>
            <span class="icon-close">â—€</span>
        </button>
    </aside>

    <main class="main-content">
        <div class="content-header">
            <h2 id="current-category-title">æ‰€æœ‰é …ç›®</h2>
            <div class="header-controls">
                <div class="font-controls">
                    <span class="font-controls-label">å…¨é«”å­—é«”ï¼š</span>
                    <button id="global-font-decrease-btn" class="btn btn-icon btn-sm" title="ç¸®å°å…¨é«”å­—é«”">ï¼</button>
                    <span id="global-font-size-display" class="current-font-size">14px</span>
                    <button id="global-font-increase-btn" class="btn btn-icon btn-sm" title="æ”¾å¤§å…¨é«”å­—é«”">ï¼‹</button>
                </div>
                <button id="add-snippet-btn" class="btn btn-primary">æ–°å¢ç¯„æœ¬</button>
            </div>
        </div>
        <div id="snippet-list" class="snippet-list"></div>
        <p id="no-snippets-message" style="display: none;">æ­£åœ¨å¾é›²ç«¯è¼‰å…¥è³‡æ–™...</p>
    </main>
</div>

<div id="category-modal-overlay" class="modal-overlay"> <div class="modal"> <div class="modal-header" id="category-modal-title"></div> <div class="modal-body"> <div id="emoji-picker" class="emoji-picker"></div> <input type="text" id="category-modal-input" placeholder="è«‹è¼¸å…¥åˆ†é¡åç¨± (å¯åŒ…å«è¡¨æƒ…ç¬¦è™Ÿ)"> </div> <div class="modal-footer"> <button id="category-modal-cancel" class="btn btn-secondary">å–æ¶ˆ</button> <button id="category-modal-confirm" class="btn btn-primary">ç¢ºå®š</button> </div> </div> </div>
<div id="snippet-modal-overlay" class="modal-overlay"> <div class="modal"> <div class="modal-header" id="snippet-modal-title"></div> <div class="modal-body"> <input type="text" id="snippet-modal-title-input" placeholder="è«‹è¼¸å…¥ç¯„æœ¬æ¨™é¡Œ"> <textarea id="snippet-modal-content-input" placeholder="è«‹è¼¸å…¥ç¯„æœ¬å…§å®¹"></textarea> </div> <div class="modal-footer"> <button id="snippet-modal-cancel" class="btn btn-secondary">å–æ¶ˆ</button> <button id="snippet-modal-confirm" class="btn btn-primary">ç¢ºå®š</button> </div> </div> </div>
<div id="move-snippet-modal-overlay" class="modal-overlay"> <div class="modal"> <div class="modal-header">ç§»å‹•ç¯„æœ¬è‡³</div> <div class="modal-body"> <select id="move-snippet-category-select"></select> </div> <div class="modal-footer"> <button id="move-snippet-modal-cancel" class="btn btn-secondary">å–æ¶ˆ</button> <button id="move-snippet-modal-confirm" class="btn btn-primary">ç¢ºå®š</button> </div> </div> </div>
<input type="file" id="import-file-input" accept=".json" style="display: none;">

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Firebase è¨­å®š ---
    // â­â­â­ è«‹å‹™å¿…åœ¨æ­¤è™•è²¼ä¸Šæ‚¨è‡ªå·±çš„ Firebase å°ˆæ¡ˆè¨­å®šç¢¼ï¼ â­â­â­
    const firebaseConfig = {
      apiKey: "AIzaSyCCVwJOEabrF05MEez7zzLMGKxGMZAe1xE",
  authDomain: "cloud-clipboard-app.firebaseapp.com",
  projectId: "cloud-clipboard-app",
  storageBucket: "cloud-clipboard-app.firebasestorage.app",
  messagingSenderId: "455861275279",
  appId: "1:455861275279:web:e4f584d358489a630cbefa"
    };
    
    // --- æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ---
    try {
        firebase.initializeApp(firebaseConfig);
    } catch (e) { console.error("Firebase åˆå§‹åŒ–å¤±æ•—: ", e); alert("Firebase åˆå§‹åŒ–å¤±æ•—ï¼"); return; }
    
    // ã€JS ä¿®æ”¹ã€‘æ–°å¢ auth æœå‹™
    const auth = firebase.auth();
    const db = firebase.firestore();
    const docRef = db.collection("clipboardData").doc("main");

    // --- DOM å…ƒç´ å®šç¾© ---
    // ã€JS æ–°å¢ã€‘Auth ç›¸é—œçš„ DOM å…ƒç´ 
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userProfile = document.getElementById('user-profile');
    const userName = document.getElementById('user-name');
    const userPic = document.getElementById('user-pic');

    const appContainer = document.getElementById('app-container');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
    const categoryList = document.getElementById('category-list');
    const snippetList = document.getElementById('snippet-list');
    const currentCategoryTitle = document.getElementById('current-category-title');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const addSnippetBtn = document.getElementById('add-snippet-btn');
    const searchBox = document.getElementById('search-box');
    const noSnippetsMessage = document.getElementById('no-snippets-message');
    const importBtn = document.getElementById('import-btn');
    const exportBtn = document.getElementById('export-btn');
    const quickAddInput = document.getElementById('quick-add-input');
    const quickAddBtn = document.getElementById('quick-add-btn');
    const importFileInput = document.getElementById('import-file-input');
    const categoryModalOverlay = document.getElementById('category-modal-overlay'); const categoryModalInput = document.getElementById('category-modal-input'); const categoryModalConfirm = document.getElementById('category-modal-confirm'); const categoryModalCancel = document.getElementById('category-modal-cancel'); const categoryModalTitle = document.getElementById('category-modal-title'); const emojiPicker = document.getElementById('emoji-picker'); const snippetModalOverlay = document.getElementById('snippet-modal-overlay'); const snippetModalTitleInput = document.getElementById('snippet-modal-title-input'); const snippetModalContentInput = document.getElementById('snippet-modal-content-input'); const snippetModalConfirm = document.getElementById('snippet-modal-confirm'); const snippetModalCancel = document.getElementById('snippet-modal-cancel'); const snippetModalTitle = document.getElementById('snippet-modal-title'); const moveSnippetModalOverlay = document.getElementById('move-snippet-modal-overlay'); const moveSnippetCategorySelect = document.getElementById('move-snippet-category-select'); const moveSnippetModalConfirm = document.getElementById('move-snippet-modal-confirm'); const moveSnippetModalCancel = document.getElementById('move-snippet-modal-cancel');
    const globalFontIncreaseBtn = document.getElementById('global-font-increase-btn');
    const globalFontDecreaseBtn = document.getElementById('global-font-decrease-btn');
    const globalFontSizeDisplay = document.getElementById('global-font-size-display');
    
    // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
    let data = [];
    let activeCategoryId = 'all';
    let globalFontSize = 14;
    let currentUser = null; // ã€JS æ–°å¢ã€‘ç”¨ä¾†å„²å­˜ç•¶å‰ä½¿ç”¨è€…ç‹€æ…‹
    const UNCATEGORIZED_ID = 'cat-uncategorized';
    const PRESET_COLORS = ['#FFFFFF', '#FFF9C4', '#C8E6C9', '#BBDEFB', '#FFCDD2', '#D1C4E9', '#CFD8DC'];

    // --- ã€JS æ–°å¢ã€‘ä½¿ç”¨è€…é©—è­‰ç›¸é—œå‡½å¼ ---
    function setupAuthObserver() {
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // ä½¿ç”¨è€…å·²ç™»å…¥
                userProfile.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                userName.textContent = user.displayName;
                userPic.src = user.photoURL;
                setEditingEnabled(true);
            } else {
                // ä½¿ç”¨è€…å·²ç™»å‡º
                userProfile.classList.add('hidden');
                loginBtn.classList.remove('hidden');
                setEditingEnabled(false);
            }
        });
    }

    function signIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            console.error("ç™»å…¥å¤±æ•—:", error);
            alert("ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å½ˆå‡ºè¦–çª—æ˜¯å¦è¢«é˜»æ“‹ï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚");
        });
    }

    function signOut() {
        auth.signOut();
    }
    
    // --- ã€JS æ–°å¢ã€‘æ¬Šé™æ§åˆ¶å‡½å¼ ---
    function setEditingEnabled(isLoggedIn) {
        // é¸æ“‡æ‰€æœ‰éœ€è¦æ¬Šé™çš„æŒ‰éˆ•å’Œè¼¸å…¥æ¡†
        const restrictedElements = [
            quickAddInput, quickAddBtn, addCategoryBtn, importBtn, addSnippetBtn,
            ...document.querySelectorAll('.edit-cat-btn'),
            ...document.querySelectorAll('.delete-cat-btn'),
            ...document.querySelectorAll('.move-snippet-btn'),
            ...document.querySelectorAll('.edit-snippet-btn'),
            ...document.querySelectorAll('.delete-snippet-btn'),
            ...document.querySelectorAll('.color-swatch'),
            ...document.querySelectorAll('.font-increase-btn'),
            ...document.querySelectorAll('.font-decrease-btn'),
            ...document.querySelectorAll('.global-font-controls')
        ];
        
        restrictedElements.forEach(el => {
            if (el) {
                el.style.display = isLoggedIn ? '' : 'none';
            }
        });

        // è™•ç†ä¸€äº›ç‰¹æ®Šæƒ…æ³ï¼Œä¾‹å¦‚ flex å®¹å™¨
        document.querySelectorAll('.category-actions, .snippet-actions').forEach(el => {
             el.style.display = isLoggedIn ? '' : 'none';
        });

        // æ›´æ–°è¼¸å…¥æ¡†çš„ placeholder æ–‡å­—
        if (quickAddInput) {
            quickAddInput.placeholder = isLoggedIn ? 'å¿«é€Ÿæ–°å¢ç¯„æœ¬...' : 'ç™»å…¥å¾Œå³å¯æ–°å¢';
            quickAddInput.disabled = !isLoggedIn;
        }

        // è®“å¡ç‰‡åœ¨ç™»å…¥æ™‚æ‰èƒ½æ‹–æ›³
        document.querySelectorAll('.snippet-card').forEach(card => {
            card.draggable = isLoggedIn;
        });
    }


    // --- è³‡æ–™æ“ä½œå‡½å¼ ---
    async function saveData(newData, showToastMsg = true) { 
        if (!currentUser) { 
            showToast('âš ï¸ è«‹å…ˆç™»å…¥æ‰èƒ½ä¿®æ”¹è³‡æ–™');
            return;
        }
        try { await docRef.set({ categories: newData }); if(showToastMsg) showToast('ğŸ’¾ è³‡æ–™å·²åŒæ­¥è‡³é›²ç«¯'); } catch (error) { console.error("å„²å­˜è³‡æ–™è‡³ Firebase æ™‚ç™¼ç”ŸéŒ¯èª¤: ", error); showToast("âŒ å„²å­˜å¤±æ•—ï¼æ¬Šé™ä¸è¶³æˆ–ç¶²è·¯éŒ¯èª¤ã€‚"); } 
    }
    function setupRealtimeListener() { docRef.onSnapshot(doc => { if (doc.exists) { const cloudData = doc.data().categories || []; if (!cloudData.find(c => c.id === UNCATEGORIZED_ID)) { cloudData.push({ id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] }); } data = cloudData; } else { const defaultData = [ { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] }, { id: 'cat-1', name: 'âœï¸ å­¸æ ¡ç”¨', snippets: [{ id: 'snip-1-1', title: 'å›å®¶ä½œæ¥­æ ¼å¼', content: 'åœ‹èªï¼š\næ•¸å­¸ï¼š\nè‹±æ–‡ï¼š\nå…¶ä»–ï¼š', color: '#BBDEFB', fontSize: 14 }] }, ]; data = defaultData; if (currentUser) { saveData(data); } } render(); }, error => { console.error("Firebase ç›£è½å™¨éŒ¯èª¤: ", error); noSnippetsMessage.textContent = 'ç„¡æ³•é€£æ¥é›²ç«¯è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase è¨­å®šã€‚'; noSnippetsMessage.style.display = 'block'; }); }
    
    // --- æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ---
    function render() { renderCategories(); renderSnippets(); }
    function renderCategories() { categoryList.innerHTML = ''; const specialCategories = [{ id: 'all', name: 'ğŸ“‘ æ‰€æœ‰ç¯„æœ¬' }, { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬' }]; specialCategories.forEach(cat => { const catData = data.find(c => c.id === cat.id); const count = cat.id === 'all' ? data.reduce((sum, c) => sum + (c.snippets ? c.snippets.length : 0), 0) : catData ? (catData.snippets ? catData.snippets.length : 0) : 0; const li = document.createElement('li'); li.className = `category-item special-category ${cat.id === activeCategoryId ? 'active' : ''}`; li.dataset.id = cat.id; li.innerHTML = `<span class="category-item-name">${escapeHtml(cat.name)} (${count})</span>`; categoryList.appendChild(li); }); const separator = document.createElement('hr'); separator.style.margin = '10px 0'; categoryList.appendChild(separator); data.filter(c => c.id !== UNCATEGORIZED_ID).forEach(category => { const li = document.createElement('li'); li.className = `category-item ${category.id === activeCategoryId ? 'active' : ''}`; li.dataset.id = category.id; li.innerHTML = `<span class="category-item-name">${escapeHtml(category.name)} (${category.snippets ? category.snippets.length : 0})</span><span class="category-actions"><button class="btn-icon edit-cat-btn" title="ç·¨è¼¯åˆ†é¡">âœï¸</button><button class="btn-icon delete-cat-btn" title="åˆªé™¤åˆ†é¡">ğŸ—‘ï¸</button></span>`; categoryList.appendChild(li); }); }
    function renderSnippets() {
        snippetList.innerHTML = '';
        let snippetsToRender = [];
        let categoryName = '';
        const searchQuery = searchBox.value.toLowerCase();
        
        if (searchQuery) {
            snippetsToRender = data.flatMap(c => c.snippets || []).filter(s => s.title.toLowerCase().includes(searchQuery) || s.content.toLowerCase().includes(searchQuery));
            categoryName = `æœå°‹çµæœ: "${searchQuery}"`;
        } else if (activeCategoryId === 'all') {
            snippetsToRender = data.flatMap(c => c.snippets || []);
            categoryName = 'æ‰€æœ‰ç¯„æœ¬';
        } else {
            const category = data.find(c => c.id === activeCategoryId);
            if (category) {
                snippetsToRender = category.snippets || [];
                categoryName = category.name;
            } else { activeCategoryId = 'all'; renderSnippets(); return; }
        }
        
        currentCategoryTitle.textContent = escapeHtml(categoryName);

        if (snippetsToRender.length > 0) {
            noSnippetsMessage.style.display = 'none';
            snippetsToRender.forEach(snippet => {
                const card = document.createElement('div');
                card.className = 'snippet-card';
                card.dataset.id = snippet.id;
                //å¡ç‰‡æ˜¯å¦å¯æ‹–æ›³çš„æ¬Šé™ï¼Œç”± setEditingEnabled æ§åˆ¶
                const currentFontSize = snippet.fontSize || globalFontSize;
                const currentBgColor = snippet.color || '#FFFFFF';
                card.style.backgroundColor = currentBgColor;
                const paletteHtml = PRESET_COLORS.map(color => `<button class="color-swatch" style="background-color: ${color}; ${color === currentBgColor ? 'border-color: var(--primary-color); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary-color);' : ''}" data-color="${color}" title="è¨­å®šé¡è‰²ç‚º ${color}"></button>`).join('');
                card.innerHTML = `
                    <div class="snippet-header"> <span class="snippet-title">${escapeHtml(snippet.title)}</span> <div class="font-controls"> <button class="btn btn-icon btn-sm font-decrease-btn" title="ç¸®å°å­—é«”">ï¼</button> <span class="current-font-size">${currentFontSize}px</span> <button class="btn btn-icon btn-sm font-increase-btn" title="æ”¾å¤§å­—é«”">ï¼‹</button> </div> </div>
                    <div class="snippet-content" style="font-size: ${currentFontSize}px;">${escapeHtml(snippet.content)}</div>
                    <div class="snippet-footer">
                        <div class="snippet-actions"> <button class="btn btn-sm btn-secondary move-snippet-btn">ç§»å‹•</button> <button class="btn btn-sm btn-secondary edit-snippet-btn">ç·¨è¼¯</button> <button class="btn btn-sm btn-danger delete-snippet-btn">åˆªé™¤</button> </div>
                        <button class="btn btn-success copy-snippet-btn">è¤‡è£½å…§å®¹</button>
                        <div class="color-palette">${paletteHtml}</div>
                    </div>`;
                snippetList.appendChild(card);
            });
        } else {
            noSnippetsMessage.style.display = 'block';
            noSnippetsMessage.textContent = searchQuery ? 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ç¯„æœ¬ã€‚' : 'é€™å€‹åˆ†é¡é‚„æ²’æœ‰ç¯„æœ¬å–”ï¼';
        }
        // ã€JS ä¿®æ”¹ã€‘æ¯æ¬¡æ¸²æŸ“å¾Œï¼Œæ ¹æ“šç™»å…¥ç‹€æ…‹æ›´æ–° UI æ¬Šé™
        setEditingEnabled(!!currentUser);
    }
    
    // --- Modal æ§åˆ¶æ¨¡çµ„ (å…§éƒ¨é‚è¼¯ä¸è®Š) ---
    const modalControls = (() => { let activeCategoryId = null; let activeSnippetId = null; let onConfirmCallback = null; const emojis = ['ğŸ“‘', 'ğŸ“‚', 'âœï¸', 'ğŸ’¡', 'ğŸ’¬', 'â¤ï¸', 'âš™ï¸', 'ğŸš€', 'ğŸ¯', 'ğŸ‰', 'ğŸ’°', 'ğŸ“ˆ', 'ğŸ””', 'ğŸŒ', 'ğŸ§‘â€ğŸ’»']; emojiPicker.innerHTML = emojis.map(e => `<button class="emoji-btn">${e}</button>`).join(''); emojiPicker.addEventListener('click', e => { if(e.target.matches('.emoji-btn')) { categoryModalInput.value += e.target.textContent; categoryModalInput.focus(); } }); function show(overlay, onShow = () => {}) { overlay.classList.add('show'); onShow(); } function hide(overlay) { overlay.classList.remove('show'); onConfirmCallback = null; } categoryModalCancel.addEventListener('click', () => hide(categoryModalOverlay)); snippetModalCancel.addEventListener('click', () => hide(snippetModalOverlay)); moveSnippetModalCancel.addEventListener('click', () => hide(moveSnippetModalOverlay)); categoryModalConfirm.addEventListener('click', () => { if (categoryModalInput.value.trim()) { onConfirmCallback(categoryModalInput.value.trim()); hide(categoryModalOverlay); } }); snippetModalConfirm.addEventListener('click', () => { if (snippetModalTitleInput.value.trim() && snippetModalContentInput.value.trim()) { onConfirmCallback({ title: snippetModalTitleInput.value.trim(), content: snippetModalContentInput.value.trim() }); hide(snippetModalOverlay); } }); moveSnippetModalConfirm.addEventListener('click', () => { onConfirmCallback(moveSnippetCategorySelect.value); hide(moveSnippetModalOverlay); }); return { openCategoryModal(categoryId, callback) { activeCategoryId = categoryId; onConfirmCallback = callback; const isEditing = !!categoryId; categoryModalTitle.textContent = isEditing ? 'ç·¨è¼¯åˆ†é¡' : 'æ–°å¢åˆ†é¡'; categoryModalInput.value = isEditing ? data.find(c => c.id === categoryId).name : ''; show(categoryModalOverlay, () => categoryModalInput.focus()); }, openSnippetModal(snippetInfo, callback) { onConfirmCallback = callback; const isEditing = typeof snippetInfo === 'object' && snippetInfo !== null; snippetModalTitle.textContent = isEditing ? 'ç·¨è¼¯ç¯„æœ¬' : 'æ–°å¢ç¯„æœ¬'; snippetModalTitleInput.value = isEditing ? snippetInfo.title : ''; snippetModalContentInput.value = isEditing ? snippetInfo.content : ''; show(snippetModalOverlay, () => snippetModalTitleInput.focus()); }, openMoveSnippetModal(snippetId, currentCatId, callback) { activeSnippetId = snippetId; onConfirmCallback = callback; moveSnippetCategorySelect.innerHTML = data.filter(c => c.id !== currentCatId && c.id !== 'all').map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join(''); show(moveSnippetModalOverlay); } }; })();

    // --- äº‹ä»¶ç›£è½å™¨è¨­ç½® ---
    function setupEventListeners() {
        // ã€JS æ–°å¢ã€‘ç™»å…¥ç™»å‡ºæŒ‰éˆ•äº‹ä»¶
        loginBtn.addEventListener('click', signIn);
        logoutBtn.addEventListener('click', signOut);

        sidebarToggleBtn.addEventListener('click', () => { appContainer.classList.toggle('sidebar-open'); localStorage.setItem('sidebarOpen', appContainer.classList.contains('sidebar-open')); });
        globalFontIncreaseBtn.addEventListener('click', () => changeGlobalFontSize(true));
        globalFontDecreaseBtn.addEventListener('click', () => changeGlobalFontSize(false));
        searchBox.addEventListener('input', renderSnippets);
        quickAddInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleQuickAdd(); } });
        quickAddBtn.addEventListener('click', handleQuickAdd);
        addCategoryBtn.addEventListener('click', () => { modalControls.openCategoryModal(null, (name) => { const newCategory = { id: `cat-${Date.now()}`, name, snippets: [] }; data.push(newCategory); saveData(data); }); });
        addSnippetBtn.addEventListener('click', () => { if (activeCategoryId === 'all') { showToast('âŒ è«‹å…ˆé¸æ“‡ä¸€å€‹å…·é«”çš„åˆ†é¡'); return; } modalControls.openSnippetModal(null, (newSnippetData) => { const category = data.find(c => c.id === activeCategoryId); if (category) { const newSnippet = { id: `snip-${Date.now()}`, ...newSnippetData, fontSize: globalFontSize, color: '#FFFFFF' }; category.snippets.unshift(newSnippet); saveData(data); } }); });
        categoryList.addEventListener('click', (e) => { const categoryItem = e.target.closest('.category-item'); if (!categoryItem) return; const categoryId = categoryItem.dataset.id; if (e.target.closest('.edit-cat-btn')) { modalControls.openCategoryModal(categoryId, (newName) => { const category = data.find(c => c.id === categoryId); if (category) { category.name = newName; saveData(data); } }); } else if (e.target.closest('.delete-cat-btn')) { deleteCategory(categoryId); } else { activeCategoryId = categoryId; searchBox.value = ''; render(); if (window.innerWidth < 768) { appContainer.classList.remove('sidebar-open'); localStorage.setItem('sidebarOpen', 'false');} } });
        snippetList.addEventListener('click', (e) => { const card = e.target.closest('.snippet-card'); if (!card) return; const snippetId = card.dataset.id; const [category, snippetIndex] = findSnippetLocation(snippetId); if (!category) return; const snippet = category.snippets[snippetIndex]; if (e.target.matches('.font-increase-btn, .font-decrease-btn')) { changeSnippetFontSize(snippetId, e.target.matches('.font-increase-btn')); } else if (e.target.matches('.copy-snippet-btn')) { navigator.clipboard.writeText(snippet.content).then(() => showToast('âœ… å·²è¤‡è£½ï¼'), () => showToast('âŒ è¤‡è£½å¤±æ•—')); } else if (e.target.matches('.edit-snippet-btn')) { modalControls.openSnippetModal({ title: snippet.title, content: snippet.content }, (updatedData) => { snippet.title = updatedData.title; snippet.content = updatedData.content; saveData(data); }); } else if (e.target.matches('.delete-snippet-btn')) { deleteSnippet(snippetId); } else if (e.target.matches('.move-snippet-btn')) { modalControls.openMoveSnippetModal(snippetId, category.id, (targetCatId) => { const targetCategory = data.find(c => c.id === targetCatId); if (targetCategory) { const [removedSnippet] = category.snippets.splice(snippetIndex, 1); targetCategory.snippets.unshift(removedSnippet); saveData(data); } }); } else if (e.target.matches('.color-swatch')) { changeSnippetColor(snippetId, e.target.dataset.color); } });
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', handleImport);
        exportBtn.addEventListener('click', handleExport);
    }
    
    // --- è¼”åŠ©å‡½å¼ (éƒ¨åˆ†ä¿®æ”¹ä»¥é©æ‡‰æ¬Šé™) ---
    function applyInitialState() { const isSidebarOpen = localStorage.getItem('sidebarOpen') === 'true'; if (isSidebarOpen) { appContainer.classList.add('sidebar-open'); } const savedSize = localStorage.getItem('globalFontSize'); if (savedSize) { globalFontSize = parseInt(savedSize, 10); } updateGlobalFontSizeDisplay(); }
    function findSnippetLocation(snippetId) { for (const category of data) { if (category.snippets) { const index = category.snippets.findIndex(s => s.id === snippetId); if (index !== -1) return [category, index]; } } return [null, -1]; }
    function changeGlobalFontSize(increase) { if (increase) { globalFontSize++; } else { globalFontSize = Math.max(8, globalFontSize - 1); } data.forEach(category => { if (category.snippets) { category.snippets.forEach(snippet => { snippet.fontSize = globalFontSize; }); } }); localStorage.setItem('globalFontSize', globalFontSize); updateGlobalFontSizeDisplay(); saveData(data, false); }
    function updateGlobalFontSizeDisplay() { globalFontSizeDisplay.textContent = `${globalFontSize}px`; }
    function changeSnippetFontSize(snippetId, increase) { const [category, snippetIndex] = findSnippetLocation(snippetId); if (category) { const snippet = category.snippets[snippetIndex]; let currentSize = snippet.fontSize || globalFontSize; if (increase) { currentSize++; } else { currentSize = Math.max(8, currentSize - 1); } snippet.fontSize = currentSize; saveData(data, false); } }
    function changeSnippetColor(snippetId, newColor) { const [category, snippetIndex] = findSnippetLocation(snippetId); if (category) { category.snippets[snippetIndex].color = newColor; saveData(data, false); } }
    function handleQuickAdd() { const content = quickAddInput.value.trim(); if (content === '') { showToast('âŒ å…§å®¹ä¸å¾—ç‚ºç©ºï¼'); return; } let uncategorized = data.find(c => c.id === UNCATEGORIZED_ID); if (!uncategorized) { uncategorized = { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] }; data.push(uncategorized); } const newSnippet = { id: `snip-${Date.now()}`, title: content.substring(0, 15) + (content.length > 15 ? '...' : ''), content: content, fontSize: globalFontSize, color: '#FFFFFF' }; uncategorized.snippets.unshift(newSnippet); quickAddInput.value = ''; showToast('âœ… å¿«é€Ÿæ–°å¢è‡³ã€Œæœªåˆ†é¡ã€'); saveData(data); }
    function deleteCategory(categoryId) { const category = data.find(c => c.id === categoryId); if (!category) return; if (confirm(`ç¢ºå®šè¦åˆªé™¤åˆ†é¡ã€Œ${category.name}ã€å—ï¼Ÿ\nåˆ†é¡ä¸‹çš„æ‰€æœ‰ç¯„æœ¬å°‡æœƒè¢«ç§»è‡³ã€Œæœªåˆ†é¡ç¯„æœ¬ã€ã€‚`)) { let uncategorized = data.find(c => c.id === UNCATEGORIZED_ID); if (!uncategorized) { uncategorized = { id: UNCATEGORIZED_ID, name: 'ğŸ“‚ æœªåˆ†é¡ç¯„æœ¬', snippets: [] }; data.push(uncategorized); } uncategorized.snippets.unshift(...(category.snippets || [])); data = data.filter(c => c.id !== categoryId); if (activeCategoryId === categoryId) { activeCategoryId = UNCATEGORIZED_ID; } saveData(data); } }
    function deleteSnippet(snippetId) { if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¯„æœ¬å—ï¼Ÿ')) { const [category, snippetIndex] = findSnippetLocation(snippetId); if (category) { category.snippets.splice(snippetIndex, 1); saveData(data); } } }
    function handleImport(event) { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (Array.isArray(importedData)) { if (confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿé€™å°‡æœƒè¦†è“‹æ‰€æœ‰é›²ç«¯ä¸Šçš„ç¾æœ‰è³‡æ–™ã€‚')) { data = importedData; saveData(data); showToast('âœ… è³‡æ–™åŒ¯å…¥æˆåŠŸï¼'); } } else { throw new Error('Invalid data format'); } } catch (error) { alert('åŒ¯å…¥å¤±æ•—ï¼æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºæˆ–å·²ææ¯€ã€‚'); } }; reader.readAsText(file); importFileInput.value = ''; } }
    function handleExport() { const dataStr = JSON.stringify(data, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; const timestamp = new Date().toISOString().slice(0, 10); link.download = `é›²æ•™å®¤å‰ªè²¼ç°¿å‚™ä»½_${timestamp}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); showToast('âœ… è³‡æ–™åŒ¯å‡ºæˆåŠŸï¼'); }
    function setupDragAndDrop() { let draggedItemId = null; snippetList.addEventListener('dragstart', e => { if (!currentUser) { e.preventDefault(); return; } const card = e.target.closest('.snippet-card'); if (card) { draggedItemId = card.dataset.id; setTimeout(() => card.classList.add('dragging'), 0); } }); snippetList.addEventListener('dragend', e => { const card = e.target.closest('.snippet-card'); if (card) card.classList.remove('dragging'); }); snippetList.addEventListener('dragover', e => e.preventDefault()); snippetList.addEventListener('drop', e => { e.preventDefault(); const targetCard = e.target.closest('.snippet-card'); if (!targetCard || targetCard.dataset.id === draggedItemId) return; const category = data.find(c => c.id === activeCategoryId); if (!category) return; const snippetArray = category.snippets; const startIndex = snippetArray.findIndex(s => s.id === draggedItemId); const endIndex = snippetArray.findIndex(s => s.id === targetCard.dataset.id); if (startIndex === -1 || endIndex === -1) return; const [removed] = snippetArray.splice(startIndex, 1); snippetArray.splice(endIndex, 0, removed); saveData(data); }); }
    function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); } function showToast(message) { const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateX(-50%) translateY(-10px)'; }, 10); setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(-50%) translateY(0)'; setTimeout(() => toast.remove(), 300); }, 2000); }

    // --- æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• ---
    if (!firebaseConfig.apiKey || !firebaseConfig.projectId || firebaseConfig.apiKey === "YOUR_API_KEY") {
        alert("éŒ¯èª¤ï¼šè«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è²¼ä¸Šæ‚¨è‡ªå·±çš„ Firebase è¨­å®šç¢¼ (firebaseConfig)ï¼");
        noSnippetsMessage.textContent = 'Firebase å°šæœªè¨­å®šã€‚è«‹ä¾ç…§èªªæ˜æ–‡ä»¶è¨­å®šå¾Œé‡æ–°æ•´ç†é é¢ã€‚';
        noSnippetsMessage.style.display = 'block';
        return;
    }
    
    applyInitialState();
    setupEventListeners();
    setupRealtimeListener();
    setupDragAndDrop();
    setupAuthObserver(); // ã€JS æ–°å¢ã€‘å•Ÿå‹•é©—è­‰ç‹€æ…‹ç›£è½
});
</script>

</body>
</html>